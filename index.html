<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë‹¨ì–´ ê³µë¶€ â€” ë©€í‹° JSON ë¡œë” (ì–¸ì–´ë³„ TTS + ì˜ˆì™¸ë°œìŒ)</title>
<style>
  :root{ --bg:#0b0d12; --card:#121620; --text:#e6e9ef; --muted:#9aa3b2; --accent:#4da3ff; --border:#1f2a3a; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,AppleGothic,Helvetica,Arial,sans-serif}
  header{padding:20px 16px;max-width:1100px;margin:0 auto}
  h1{margin:0 0 6px;font-size:24px;letter-spacing:-0.2px}
  p.lead{margin:0 0 12px;color:var(--muted);font-size:13px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .bar > *{background:#0e131c;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;font-size:13px}
  .bar button{cursor:pointer}
  .wrap{max-width:1100px;margin:0 auto;padding:0 16px 24px}
  ul.vlist{list-style:none;padding:0;margin:14px 0;display:flex;flex-direction:column;gap:14px;}
  li.item{display:flex;gap:14px;background:#121620;border:1px solid var(--border);border-radius:12px;padding:12px;position:relative}
  .thumb{flex-shrink:0;width:120px;height:90px;object-fit:contain;border-radius:8px;background:#1c2330;padding:6px}
  .text{flex:1;display:flex;flex-direction:column;gap:4px}
  .wordline{display:flex;align-items:center;gap:8px;font-weight:700;font-size:17px}
  .pos{font-size:11px;padding:2px 8px;background:#1e2838;border-radius:999px;color:#b8c2d3}
  .desc{font-size:14px}
  .example{font-size:13px;color:#d1d5db;background:#1e2838;padding:6px 8px;border-left:3px solid var(--accent);border-radius:4px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
  .example .extext{flex:1;min-width:250px}
  .meta{margin-top:4px;font-size:11px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
  .meta a{color:var(--accent)}
  .check{position:absolute;top:12px;right:12px;display:flex;align-items:center;gap:4px;font-size:11px;color:#babec9}
  .badge{font-size:10px;color:#ffd1d1;background:#3a1e1e;border:1px solid #583333;padding:2px 6px;border-radius:999px;display:none}

  .speakbtn{
    border:1px solid var(--border);
    background:#1e2838;color:#cbd5e1;
    width:26px;height:26px;border-radius:8px;
    display:inline-flex;align-items:center;justify-content:center;
    cursor:pointer;transition:background .15s,color .15s,transform .05s;
  }
  .speakbtn:hover{ background:#283349; color:#fff; }
  .speakbtn:active{ transform:translateY(1px); }
  .speakbtn svg{ width:16px;height:16px; display:block; }

  /* ìƒë‹¨ ë³´ì¡° ì˜µì…˜ */
  .bar .inline{display:flex;gap:8px;align-items:center;padding:0;border:none;background:transparent}
  .bar .inline label{display:flex;gap:6px;align-items:center;font-size:12px;color:#cbd5e1}
  .bar .inline select{padding:6px 8px;border-radius:8px;background:#0e131c;border:1px solid var(--border);color:#e6e9ef;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>ë‹¨ì–´ ê³µë¶€ â€” ë©€í‹° JSON ë¡œë”</h1>
  <p class="lead">ì–¸ì–´/ì„¸íŠ¸ë¥¼ ì„ íƒí•´ ë Œë”ë§í•˜ê³ , í…ìŠ¤íŠ¸ ì–¸ì–´ì— ë§ëŠ” ë³´ì´ìŠ¤ë¡œ ì½ì–´ì¤ë‹ˆë‹¤. (ì²´í¬ ìƒíƒœëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥)</p>
  <div class="bar">
    <select id="langSel"><option value="">ì–¸ì–´ ì„ íƒâ€¦</option></select>
    <select id="setSel" disabled><option value="">ì„¸íŠ¸ ì„ íƒâ€¦</option></select>
    <label><input id="onlyNew" type="checkbox"> ì™¸ì›€ ë¯¸ì²´í¬ë§Œ ë³´ê¸°</label>
    <button id="reload">ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <div class="inline">
      <label title="ë¬¸ì ë²”ìœ„ë¥¼ ë³´ê³  ì–¸ì–´ë¥¼ ìë™ìœ¼ë¡œ ê³ ë¦…ë‹ˆë‹¤(í•œ/ì¼/ë¼í‹´ ë“±)">
        <input id="autoLang" type="checkbox" checked> ìë™ ì–¸ì–´ ê°ì§€
      </label>
      <label>ê°•ì œ ë¡œìº˜
        <select id="forceLocale">
          <option value="">(ì„ íƒëœ ì–¸ì–´ ê¸°ì¤€)</option>
          <option>ja-JP</option><option>ko-KR</option><option>en-US</option><option>en-GB</option>
          <option>zh-CN</option><option>zh-TW</option><option>fr-FR</option><option>de-DE</option>
          <option>es-ES</option><option>it-IT</option><option>th-TH</option><option>vi-VN</option><option>id-ID</option>
        </select>
      </label>
    </div>

    <a id="openQuiz" href="./quiz.html" style="text-decoration:none" target="_blank">ë¬¸ì œ í’€ê¸° ì—´ê¸° â†—</a>
    <span id="status" style="margin-left:auto;color:#9aa3b2"></span>
  </div>
</header>
<div class="wrap">
  <ul id="list" class="vlist"></ul>
</div>
<script>
/* ===== ê³µí†µ ===== */
const $ = s => document.querySelector(s);
const list = $('#list');
const statusEl = $('#status');
let DATASETS = null;
let CURRENT = null;

/* ===== datasets.json ===== */
async function loadManifest(){
  const res = await fetch('./datasets.json?v=2025-08-11');
  if(!res.ok) throw new Error('datasets.json ë¡œë“œ ì‹¤íŒ¨');
  return await res.json();
}
function fillSelectors(manifest){
  const langSel = $('#langSel');
  langSel.innerHTML = '<option value="">ì–¸ì–´ ì„ íƒâ€¦</option>' + (manifest.languages||[]).map(l => `<option value="${l.id}">${l.name}</option>`).join('');
  $('#setSel').innerHTML = '<option value="">ì„¸íŠ¸ ì„ íƒâ€¦</option>';
  $('#setSel').disabled = true;
}
$('#langSel').addEventListener('change', (e)=>{
  const id = e.target.value;
  const lang = (DATASETS.languages||[]).find(l => l.id===id);
  const setSel = $('#setSel');
  if(!lang){ setSel.innerHTML='<option value="">ì„¸íŠ¸ ì„ íƒâ€¦</option>'; setSel.disabled=true; return; }
  setSel.disabled = false;
  setSel.innerHTML = '<option value="">ì„¸íŠ¸ ì„ íƒâ€¦</option>' + (lang.files||[]).map(f=>`<option value="${f.path}">${f.title || f.path}</option>`).join('');
});
$('#reload').addEventListener('click', ()=>{
  const path = $('#setSel').value;
  if(!path) return alert('ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  loadJSON(path);
});
$('#onlyNew').addEventListener('change', ()=>{ if(CURRENT) render(CURRENT); });

/* ===== ë°ì´í„° ë¡œë“œ ===== */
async function loadJSON(path){
  statusEl.textContent = 'ë¡œë”© ì¤‘â€¦';
  const res = await fetch(path);
  if(!res.ok){ statusEl.textContent='JSON ë¡œë“œ ì‹¤íŒ¨'; return; }
  const arr = await res.json();
  CURRENT = (Array.isArray(arr) ? arr : []);
  render(CURRENT);
}

/* ===== TTS (ì–¸ì–´ë³„ + ì˜ˆì™¸ë°œìŒ) ===== */
const synth = window.speechSynthesis;
let VOICES = [];
let VOICES_READY = false;

// ì–¸ì–´ì½”ë“œ â†’ ëŒ€í‘œ ë¡œìº˜ ë§¤í•‘
const LOCALE_MAP = {
  en: 'en-US', ja: 'ja-JP', ko: 'ko-KR', zh: 'zh-CN', 'zh-hant': 'zh-TW',
  fr: 'fr-FR', de: 'de-DE', es: 'es-ES', it: 'it-IT', th: 'th-TH', vi: 'vi-VN', id: 'id-ID'
};
const VENDOR_PREF = /Google|Microsoft|Siri|Apple/i;

function refreshVoices(){ VOICES = synth.getVoices(); VOICES_READY = VOICES.length > 0; }
function waitVoices(timeoutMs=2500){
  return new Promise(resolve=>{
    const t0 = Date.now();
    (function loop(){
      refreshVoices();
      if(VOICES_READY || Date.now()-t0>timeoutMs) return resolve(VOICES);
      setTimeout(loop, 100);
    })();
  });
}
if ('speechSynthesis' in window) {
  window.speechSynthesis.addEventListener('voiceschanged', refreshVoices);
  refreshVoices();
}

// â”€â”€ ìë™ ì–¸ì–´ ê°ì§€(ê°„ë‹¨íˆ ë¬¸ì ë²”ìœ„ ê¸°ë°˜)
function detectLangFromText(text){
  if (!text) return '';
  if (/[ã-ã‚Ÿã‚ -ãƒ¿ä¸€-é¾¯]/.test(text)) return 'ja-JP'; // ê°€ë‚˜/í•œì í¬í•¨ â†’ ì¼ë³¸ì–´
  if (/[ê°€-í£]/.test(text)) return 'ko-KR';
  if (/[ä¸€-é¾¯]/.test(text)) return 'zh-CN';          // í•œìë§Œ ìˆì„ ë•Œ ì¤‘êµ­ì–´ ì¶”ì •
  if (/[A-Za-z]/.test(text)) return 'en-US';
  return '';
}

function pickVoiceByLocale(locale){
  if(!VOICES_READY) refreshVoices();
  if(!VOICES.length) return null;
  const lc = (locale||'').toLowerCase();
  let cands = VOICES.filter(v => (v.lang||'').toLowerCase() === lc);
  let v = cands.find(v=>VENDOR_PREF.test(v.name)) || cands[0];
  if (v) return v;
  cands = VOICES.filter(v => (v.lang||'').toLowerCase().startsWith(lc.slice(0,2)));
  v = cands.find(v=>VENDOR_PREF.test(v.name)) || cands[0];
  return v || VOICES[0] || null;
}

/* === ì˜ˆì™¸ ë°œìŒ ê·œì¹™ ===
   - ì¼ë³¸ì–´ ì¹´ìš´í„°(æœ¬/äºº), ì¼ì(æ—¥) íŠ¹ìˆ˜ ì½ê¸°
   - ë‹¨ì–´ "æœ¬" ê¸°ë³¸: ã»ã‚“
   - í•„ìš” ì‹œ ì•„ë˜ EXCEPTIONSì— ë‹¨ì–´ë³„ ê°•ì œ ì½ê¸° ì¶”ê°€
*/
const EXCEPTIONS = {
  'ja-JP': {
    // ë‹¨ì–´ ë ˆë²¨ ì»¤ìŠ¤í…€(ì •í™• ë§¤ì¹­ ì‹œ êµì²´) â€” ì›ë¬¸:ì½ê¸°
    words: {
      'æœ¬': 'ã»ã‚“', // ë‹¨ë… 'ë³¸' â†’ 'ã»ã‚“' (ë¬¸ë§¥ìƒ ì±…)
    }
  },
  'en-US': {
    words: {
      'etc.': 'et cetera',
      'Dr.': 'Doctor',
    }
  }
};

// ì¼ë³¸ì–´: ì•„ë¼ë¹„ì•„/í•œì ìˆ«ì ë‘˜ ë‹¤ ì§€ì› (ê°„ë‹¨ ë²„ì „)
const jpNumeralMap = {
  '1':'ã„ã¡','2':'ã«','3':'ã•ã‚“','4':'ã‚ˆã‚“','5':'ã”','6':'ã‚ã','7':'ãªãª','8':'ã¯ã¡','9':'ãã‚…ã†','10':'ã˜ã‚…ã†'
};
const kanjiToArabic = {'ä¸€':'1','äºŒ':'2','ä¸‰':'3','å››':'4','äº”':'5','å…­':'6','ä¸ƒ':'7','å…«':'8','ä¹':'9','å':'10'};

// 1~10 + æœ¬ â†’ íŠ¹ìˆ˜ ì½ê¸°
function readingHon(n){
  const num = Number(n);
  switch(num){
    case 1: return 'ã„ã£ã½ã‚“';
    case 2: return 'ã«ã»ã‚“';
    case 3: return 'ã•ã‚“ã¼ã‚“';
    case 4: return 'ã‚ˆã‚“ã»ã‚“';
    case 5: return 'ã”ã»ã‚“';
    case 6: return 'ã‚ã£ã½ã‚“';
    case 7: return 'ãªãªã»ã‚“';
    case 8: return 'ã¯ã£ã½ã‚“';
    case 9: return 'ãã‚…ã†ã»ã‚“';
    case 10: return 'ã˜ã‚…ã£ã½ã‚“';
    default: return jpNumeralMap[n] ? `${jpNumeralMap[n]}ã»ã‚“` : `${n}ã»ã‚“`;
  }
}
// 1/2 äºº íŠ¹ìˆ˜, ê·¸ ì™¸ ï½ã«ã‚“
function readingNin(n){
  const num = Number(n);
  if (num===1) return 'ã²ã¨ã‚Š';
  if (num===2) return 'ãµãŸã‚Š';
  return (jpNumeralMap[n] ? jpNumeralMap[n] : n) + 'ã«ã‚“';
}
// 1~10,20 æ—¥ íŠ¹ìˆ˜
function readingDay(n){
  const num = Number(n);
  const map = {1:'ã¤ã„ãŸã¡',2:'ãµã¤ã‹',3:'ã¿ã£ã‹',4:'ã‚ˆã£ã‹',5:'ã„ã¤ã‹',6:'ã‚€ã„ã‹',7:'ãªã®ã‹',8:'ã‚ˆã†ã‹',9:'ã“ã“ã®ã‹',10:'ã¨ãŠã‹',20:'ã¯ã¤ã‹'};
  return map[num] || ((jpNumeralMap[n] ? jpNumeralMap[n] : n) + 'ã«ã¡');
}

// ì¼ë³¸ì–´ ë¬¸ì¥ êµì •
function fixJapanese(text){
  if(!text) return text;

  // (1) ë‹¨ì–´ ì‚¬ì „ ì¹˜í™˜(ì •í™• ë§¤ì¹­)
  if (EXCEPTIONS['ja-JP'].words[text]) return EXCEPTIONS['ja-JP'].words[text];

  let out = text;

  // (2) ìˆ«ì+æœ¬ / äºº / æ—¥ íŒ¨í„´ ì²˜ë¦¬
  // - ì•„ë¼ë¹„ì•„ ìˆ«ì
  out = out.replace(/(\d+)\s*æœ¬/g, (_,n)=>readingHon(n));
  out = out.replace(/(\d+)\s*äºº/g, (_,n)=>readingNin(n));
  out = out.replace(/(\d+)\s*æ—¥/g, (_,n)=>readingDay(n));

  // - í•œì ìˆ«ì (ê°„ë‹¨: 1~10, å ì²˜ë¦¬)
  out = out.replace(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*æœ¬/g, (_,k)=>{
    const n = (k.split('').map(ch => kanjiToArabic[ch]||'').join('')) || k;
    const num = n==='10' || k==='å' ? 10 : Number(n);
    return readingHon(num||k);
  });
  out = out.replace(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*äºº/g, (_,k)=>{
    const n = (k.split('').map(ch => kanjiToArabic[ch]||'').join('')) || k;
    const num = n==='10' || k==='å' ? 10 : Number(n);
    return readingNin(num||k);
  });
  out = out.replace(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*æ—¥/g, (_,k)=>{
    const n = (k.split('').map(ch => kanjiToArabic[ch]||'').join('')) || k;
    const num = n==='10' || k==='å' ? 10 : Number(n);
    return readingDay(num||k);
  });

  return out;
}

// ê³µí†µ ì˜ˆì™¸ ì ìš© (localeë³„)
function applyPronunciationExceptions(text, locale){
  if(!text) return text;
  const lc = (locale||'').toLowerCase();

  if (lc.startsWith('ja')) {
    return fixJapanese(text);
  }

  // ë‹¨ì–´ ì‚¬ì „(ì˜ì–´ ë“±)
  const langKey = lc.startsWith('en') ? 'en-US' : null;
  if (langKey && EXCEPTIONS[langKey]) {
    const dict = EXCEPTIONS[langKey].words;
    // ì •í™• ë§¤ì¹­ ì‹œë§Œ ì¹˜í™˜ (ë¬¸ì¥ ë‚´ í† í° ì¹˜í™˜ì€ ê³¼ì‰ì¼ ìˆ˜ ìˆì–´ ë³´ìˆ˜ì ìœ¼ë¡œ)
    if (dict[text]) return dict[text];
  }
  return text;
}

async function speak(text, opts={}){
  if (!('speechSynthesis' in window)) { alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
  await waitVoices();

  const { langSelValue='', forceLocaleEl=$('#forceLocale'), autoEl=$('#autoLang') } = opts;
  const forced = forceLocaleEl?.value || '';
  const auto = !!autoEl?.checked;

  // 1) ê°•ì œ ë¡œìº˜ ìš°ì„ 
  let locale = forced;
  // 2) ìë™ ê°ì§€
  if (!locale && auto) locale = detectLangFromText(text);
  // 3) ì…€ë ‰í„° ë¡œìº˜
  if (!locale) {
    const id = (langSelValue||'').toLowerCase();
    locale = LOCALE_MAP[id] || (id ? `${id}-${id.toUpperCase()}` : 'en-US');
  }

  // â˜… ì˜ˆì™¸ë°œìŒ ì ìš©
  const fixed = applyPronunciationExceptions(text, locale);

  const voice = pickVoiceByLocale(locale);
  const u = new SpeechSynthesisUtterance(fixed);
  if (voice) { u.voice = voice; u.lang = voice.lang; }
  else { u.lang = locale; }

  u.rate = 1; u.pitch = 1; u.volume = 1;
  synth.cancel();
  synth.speak(u);
}

/* ===== ë Œë”ë§ ===== */
function speakIconSVG(){
  return `<svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 10v4h3l4 4V6L6 10H3zm13.5 2a4.5 4.5 0 0 0-2.25-3.89v7.78A4.5 4.5 0 0 0 16.5 12zm-2.25-8.46v2.09a7.5 7.5 0 0 1 0 12.74v2.09c3.53-1.23 6-4.57 6-8.46s-2.47-7.23-6-8.46z"/></svg>`;
}

function render(items){
  const list = $('#list');
  list.innerHTML = '';
  const onlyNew = $('#onlyNew').checked;
  const filtered = (items||[])
    .filter(x => x && x.word && x.pos && x.meaning && x.example_en && x.example_gloss && x.image_url && x.source_link)
    .filter(x => !onlyNew || localStorage.getItem('learned_'+x.word) !== 'true');

  if(filtered.length===0){ statusEl.textContent='í‘œì‹œí•  í•­ëª© ì—†ìŒ'; return; }
  statusEl.textContent = filtered.length + 'ê°œ í•­ëª©';

  const frag = document.createDocumentFragment();
  const placeholder = 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg';

  filtered.forEach(it => {
    const li = document.createElement('li');
    li.className='item';
    li.dataset.word = it.word;
    li.dataset.example = it.example_en;
    li.innerHTML = `
      <img class="thumb" src="${it.image_url}" alt="${it.word}">
      <div class="text">
        <div class="wordline">
          ${it.word}
          <button class="speakbtn" type="button" data-type="word" title="ë‹¨ì–´ ë°œìŒ ë“£ê¸°" aria-label="ë‹¨ì–´ ë°œìŒ ë“£ê¸°">${speakIconSVG()}</button>
          <span class="pos">${it.pos}</span>
          <span class="badge">ì´ë¯¸ì§€ êµì²´ í•„ìš”</span>
        </div>
        <div class="desc">${it.meaning}</div>
        <div class="example">
          <span class="extext">ğŸ’¬ ${it.example_en}<br>(${it.example_gloss})</span>
          <button class="speakbtn" type="button" data-type="example" title="ì˜ˆì‹œ ë¬¸ì¥ ì½ê¸°" aria-label="ì˜ˆì‹œ ë¬¸ì¥ ì½ê¸°">${speakIconSVG()}</button>
        </div>
        <div class="meta"><a href="${it.source_link}" target="_blank">ì¶œì²˜</a><a href="${it.image_url}" target="_blank">ì´ë¯¸ì§€ URL</a></div>
      </div>
      <label class="check"><input type="checkbox">ì™¸ì›€</label>
    `;

    const img = li.querySelector('img.thumb');
    const badge = li.querySelector('.badge');
    img.onerror = () => { img.src = placeholder; badge.style.display='inline-block'; };

    const cb = li.querySelector('.check input');
    const key = 'learned_' + it.word;
    if(localStorage.getItem(key)==='true') cb.checked = true;
    cb.addEventListener('change', ()=> localStorage.setItem(key, cb.checked));

    frag.appendChild(li);
  });
  list.appendChild(frag);
}

/* ë¦¬ìŠ¤íŠ¸ ë‚´ ğŸ”Š ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„ */
list.addEventListener('click', (e)=>{
  const btn = e.target.closest('.speakbtn');
  if(!btn) return;
  const li = btn.closest('li.item');
  const langId = $('#langSel').value || '';
  const type = btn.dataset.type;
  const text = type === 'example' ? (li?.dataset.example || '') : (li?.dataset.word || '');
  speak(text, { langSelValue: langId, forceLocaleEl: $('#forceLocale'), autoEl: $('#autoLang') });
});

/* ì´ˆê¸°í™” */
(async function init(){
  try{
    DATASETS = await loadManifest();
    fillSelectors(DATASETS);
    statusEl.textContent = 'datasets.json ë¡œë“œ ì™„ë£Œ';
  } catch(err){
    statusEl.textContent = 'ì˜¤ë¥˜: ' + err.message + ' â€” íŒŒì¼ì„ ì›¹ì„œë²„ì—ì„œ ì—´ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
  }
})();
</script>
</body>
</html>
